// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model
model User {
  id           String   @id @default(uuid())
  username     String   @unique @db.VarChar(50)
  email        String   @unique @db.VarChar(100)
  password     String
  creditsCash  Decimal  @default(50) @map("credits_cash") @db.Decimal(10, 2)
  creditsBonus Decimal  @default(100) @map("credits_bonus") @db.Decimal(10, 2)
  isActive     Boolean  @default(true) @map("is_active")
  avatar       String?  @db.VarChar(255)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  cards            BingoCard[]
  hostedGames      Game[]               @relation("GameHost")
  wonGames         Game[]               @relation("GameWinner")
  transactions     Transaction[]
  dailyMissions    UserDailyMission[]
  gameParticipants GameParticipant[]

  @@map("users")
}

// Game model
model Game {
  id             String     @id @default(uuid())
  mode           GameMode   @default(SINGLE)
  status         GameStatus @default(WAITING)
  cardSize       CardSize   @default(CLASSIC_5X5) @map("card_size")
  betAmount      Decimal    @map("bet_amount") @db.Decimal(10, 2)
  prizePool      Decimal    @default(0) @map("prize_pool") @db.Decimal(10, 2)
  houseEdge      Decimal    @default(20) @map("house_edge") @db.Decimal(5, 2)
  drawnNumbers   Int[]      @default([]) @map("drawn_numbers")
  currentNumber  Int?       @map("current_number")
  winnerId       String?    @map("winner_id")
  hostId         String?    @map("host_id")
  maxPlayers     Int        @default(1) @map("max_players")
  currentPlayers Int        @default(0) @map("current_players")
  isPrivate      Boolean    @default(false) @map("is_private")
  startedAt      DateTime?  @map("started_at")
  finishedAt     DateTime?  @map("finished_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  // Relations
  winner       User?              @relation("GameWinner", fields: [winnerId], references: [id])
  host         User?              @relation("GameHost", fields: [hostId], references: [id])
  cards        BingoCard[]
  participants GameParticipant[]

  @@map("games")
}

// BingoCard model
model BingoCard {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  gameId        String   @map("game_id")
  numbers       Json
  markedNumbers Int[]    @default([]) @map("marked_numbers")
  hasWon        Boolean  @default(false) @map("has_won")
  markedCount   Int      @default(0) @map("marked_count")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])
  game Game @relation(fields: [gameId], references: [id])

  @@map("bingo_cards")
}

// GameParticipant model - Registro de participantes y premios escalonados
model GameParticipant {
  id        String   @id @default(uuid())
  gameId    String   @map("game_id")
  userId    String   @map("user_id")
  position  Int?     // 1 = primero, 2 = segundo, 3 = tercero, null = sin premio
  prize     Decimal  @default(0) @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  game Game @relation(fields: [gameId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@unique([gameId, userId])
  @@map("game_participants")
}

// Transaction model - Historial de transacciones de créditos
model Transaction {
  id              String          @id @default(uuid())
  userId          String          @map("user_id")
  type            TransactionType
  creditType      CreditType      @map("credit_type")
  amount          Decimal         @db.Decimal(10, 2)
  balanceBefore   Decimal         @map("balance_before") @db.Decimal(10, 2)
  balanceAfter    Decimal         @map("balance_after") @db.Decimal(10, 2)
  description     String          @db.VarChar(255)
  referenceId     String?         @map("reference_id") // ID de game, mission, etc.
  referenceType   String?         @map("reference_type") // 'game', 'mission', 'deposit', etc.
  createdAt       DateTime        @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("transactions")
}

// DailyMission model - Definición de misiones diarias
model DailyMission {
  id          String   @id @default(uuid())
  key         String   @unique @db.VarChar(50) // Ej: 'login_daily', 'play_3_games'
  name        String   @db.VarChar(100)
  description String   @db.VarChar(255)
  rewardType  CreditType @map("reward_type")
  rewardAmount Decimal  @map("reward_amount") @db.Decimal(10, 2)
  targetCount Int      @default(1) @map("target_count") // Cantidad objetivo (ej: 3 partidas)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  userMissions UserDailyMission[]

  @@map("daily_missions")
}

// UserDailyMission model - Progreso de misiones por usuario
model UserDailyMission {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  missionId       String   @map("mission_id")
  currentCount    Int      @default(0) @map("current_count")
  isCompleted     Boolean  @default(false) @map("is_completed")
  completedAt     DateTime? @map("completed_at")
  lastResetAt     DateTime @default(now()) @map("last_reset_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user    User         @relation(fields: [userId], references: [id])
  mission DailyMission @relation(fields: [missionId], references: [id])

  @@unique([userId, missionId])
  @@map("user_daily_missions")
}

// Enums
enum GameMode {
  SINGLE
  MULTIPLAYER
}

enum GameStatus {
  WAITING
  PLAYING
  FINISHED
  CANCELLED
}

enum CardSize {
  RAPID_3X3
  CLASSIC_5X5
}

enum TransactionType {
  DEPOSIT      // Depósito de dinero real
  WITHDRAW     // Retiro de créditos
  GAME_BET     // Apuesta en juego
  GAME_WIN     // Premio ganado
  MISSION_REWARD // Recompensa de misión
  ADMIN_ADJUST // Ajuste manual del admin
  BONUS_GIFT   // Regalo/promoción
}

enum CreditType {
  CASH   // Retirable
  BONUS  // No retirable
}
